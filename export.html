
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HTML Print Viewer</title>
  <style>
    :root {
      color-scheme: light dark;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      background: var(--page-bg, #f4f5f7);
      color: inherit;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      padding: 1rem clamp(1rem, 5vw, 2.5rem);
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
      background: rgba(255, 255, 255, 0.75);
      backdrop-filter: blur(12px);
    }

    header h1 {
      margin: 0;
      font-size: clamp(1.3rem, 2.8vw, 1.9rem);
      font-weight: 600;
    }

    main {
      flex: 1;
      display: grid;
      grid-template-columns: minmax(320px, 380px) 1fr;
      gap: 0;
      min-height: 0;
    }

    @media (max-width: 960px) {
      main {
        grid-template-columns: 1fr;
        grid-template-rows: auto minmax(50vh, 1fr);
      }
    }

    .panel {
      padding: clamp(1rem, 3vw, 1.6rem);
      overflow-y: auto;
      background: rgba(255, 255, 255, 0.6);
      backdrop-filter: blur(12px);
      border-right: 1px solid rgba(0, 0, 0, 0.08);
    }

    @media (max-width: 960px) {
      .panel {
        border-right: none;
        border-bottom: 1px solid rgba(0, 0, 0, 0.08);
      }
    }

    .panel h2 {
      margin-top: 0;
      font-size: 1.1rem;
    }

    fieldset {
      border: 1px solid rgba(0, 0, 0, 0.12);
      border-radius: 0.75rem;
      padding: 1rem;
      margin-bottom: 1.25rem;
    }

    fieldset legend {
      font-weight: 600;
      padding: 0 0.5rem;
    }

    label {
      display: block;
      font-size: 0.85rem;
      font-weight: 500;
      margin-top: 0.75rem;
    }

    input[type="file"],
    select,
    input[type="number"],
    input[type="text"],
    input[type="range"],
    textarea {
      width: 100%;
      margin-top: 0.4rem;
      font: inherit;
      border: 1px solid rgba(0, 0, 0, 0.25);
      border-radius: 0.55rem;
      padding: 0.45rem 0.6rem;
      background: rgba(255, 255, 255, 0.9);
      box-sizing: border-box;
    }

    input[type="range"] {
      padding: 0;
    }

    .inline-controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 0.75rem;
    }

    .checkbox-inline {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.75rem;
      font-size: 0.9rem;
    }

    button {
      appearance: none;
      border: none;
      border-radius: 999px;
      padding: 0.6rem 1.2rem;
      font: inherit;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(120deg, #1f6feb, #4f9dfa);
      color: white;
      box-shadow: 0 4px 12px rgba(31, 111, 235, 0.25);
      transition: transform 0.15s ease, box-shadow 0.15s ease;
      margin-top: 0.8rem;
    }

    button.secondary {
      background: none;
      color: #1f6feb;
      border: 1px solid currentColor;
      box-shadow: none;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 18px rgba(31, 111, 235, 0.32);
    }

    button.secondary:hover {
      transform: none;
      box-shadow: none;
      background: rgba(31, 111, 235, 0.08);
    }

    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      margin-top: 0.8rem;
    }

    #status {
      margin-top: 0.75rem;
      font-size: 0.85rem;
      color: rgba(0, 0, 0, 0.65);
    }

    #command-output {
      font-family: "SFMono-Regular", ui-monospace, "Roboto Mono", "Fira Code", monospace;
      min-height: 6rem;
      resize: vertical;
    }

    .preview {
      position: relative;
      background: #1e222b;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      justify-content: stretch;
    }

    .preview iframe {
      flex: 1;
      border: none;
      background: white;
      width: 100%;
    }

    .preview-placeholder {
      color: rgba(255, 255, 255, 0.7);
      text-align: center;
      margin: auto;
      max-width: min(520px, 90%);
      line-height: 1.55;
    }

    details summary {
      cursor: pointer;
      font-weight: 600;
    }

    .help {
      font-size: 0.85rem;
      line-height: 1.5;
    }

    .note {
      margin-top: 0.6rem;
      font-size: 0.8rem;
      color: rgba(0, 0, 0, 0.6);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.25rem 0.65rem;
      border-radius: 999px;
      background: rgba(31, 111, 235, 0.15);
      color: #1f6feb;
      font-size: 0.75rem;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <header>
    <h1>HTML Print Viewer &amp; Headless PDF Helper</h1>
  </header>
  <main>
    <section class="panel" aria-label="Controls">
      <h2>1. Load a source HTML file</h2>
      <input id="file-input" type="file" accept="text/html,.html,.htm" />
      <p class="note">The document is loaded locally inside the preview—no upload is performed.</p>
      <label for="base-url">Asset base URL (optional)</label>
      <input id="base-url" type="text" placeholder="e.g. file:///Users/me/site/ or https://example.com/" />
      <p class="note">If your HTML references external resources, provide an absolute base URL so the preview can resolve them.</p>

      <h2>2. Configure layout &amp; fidelity</h2>
      <form id="options-form">
        <fieldset>
          <legend>Page setup</legend>
          <label for="page-size">Page size</label>
          <select id="page-size" name="pageSize">
            <option value="A4" selected>A4 — 210 × 297 mm</option>
            <option value="Letter">US Letter — 8.5 × 11 in</option>
            <option value="Legal">US Legal — 8.5 × 14 in</option>
            <option value="A3">A3 — 297 × 420 mm</option>
            <option value="Tabloid">Tabloid — 11 × 17 in</option>
            <option value="Custom">Custom…</option>
          </select>
          <div id="custom-size-fields" hidden>
            <div class="inline-controls">
              <div>
                <label for="custom-width">Width</label>
                <input id="custom-width" type="number" min="1" step="0.1" value="210" />
              </div>
              <div>
                <label for="custom-height">Height</label>
                <input id="custom-height" type="number" min="1" step="0.1" value="297" />
              </div>
              <div>
                <label for="custom-unit">Units</label>
                <select id="custom-unit">
                  <option value="mm" selected>Millimetres</option>
                  <option value="in">Inches</option>
                </select>
              </div>
            </div>
          </div>

          <label for="orientation">Orientation</label>
          <select id="orientation" name="orientation">
            <option value="portrait" selected>Portrait</option>
            <option value="landscape">Landscape</option>
          </select>

          <label for="margin-preset">Margins</label>
          <select id="margin-preset" name="marginPreset">
            <option value="normal" selected>Normal — 1 in</option>
            <option value="narrow">Narrow — 0.5 in</option>
            <option value="wide">Wide — 1.5 in</option>
            <option value="none">None</option>
            <option value="custom">Custom…</option>
          </select>

          <div id="custom-margins" class="inline-controls" hidden>
            <div>
              <label for="margin-top">Top (in)</label>
              <input id="margin-top" type="number" min="0" step="0.1" value="1" />
            </div>
            <div>
              <label for="margin-right">Right (in)</label>
              <input id="margin-right" type="number" min="0" step="0.1" value="1" />
            </div>
            <div>
              <label for="margin-bottom">Bottom (in)</label>
              <input id="margin-bottom" type="number" min="0" step="0.1" value="1" />
            </div>
            <div>
              <label for="margin-left">Left (in)</label>
              <input id="margin-left" type="number" min="0" step="0.1" value="1" />
            </div>
          </div>
        </fieldset>

        <fieldset>
          <legend>Fidelity &amp; render tweaks</legend>
          <label for="scale">Scale <span id="scale-display" class="pill">100%</span></label>
          <input id="scale" type="range" min="50" max="200" step="1" value="100" />

          <label for="virtual-time">Virtual time budget (ms)</label>
          <input id="virtual-time" type="number" min="0" step="100" value="1000" />

          <div class="checkbox-inline">
            <input id="print-backgrounds" type="checkbox" />
            <label for="print-backgrounds">Force background colours &amp; images</label>
          </div>

          <div class="checkbox-inline">
            <input id="emulate-screen" type="checkbox" checked />
            <label for="emulate-screen">Prefer screen styles (adds <code>@media screen</code> look)</label>
          </div>

          <div class="checkbox-inline">
            <input id="auto-print" type="checkbox" />
            <label for="auto-print">Auto-print when opened (for headless runs)</label>
          </div>
        </fieldset>
      </form>

      <div class="actions">
        <button type="button" id="apply">Apply to preview</button>
        <button type="button" id="print">Print / Save as PDF</button>
        <button type="button" id="copy-command" class="secondary">Copy headless command</button>
      </div>

      <div id="status" role="status" aria-live="polite">Waiting for a document…</div>

      <details>
        <summary>Headless print command</summary>
        <p class="help">Use the generated command with Chromium or Google Chrome to render the current preview straight to a PDF, fully unattended. Replace <code>&lt;path-to-viewer&gt;</code> and <code>output.pdf</code> with paths on your system.</p>
        <textarea id="command-output" readonly></textarea>
        <p class="note">Tip: the command encodes the loaded HTML and settings in the URL fragment. You can also share that link for reproducible print jobs.</p>
      </details>

      <details>
        <summary>How it works</summary>
        <div class="help">
          <p>The viewer never uploads your file. Everything runs locally in the browser. Layout choices are injected via <code>@page</code> rules and helper CSS.</p>
          <p>The headless command uses <code>--print-to-pdf</code> with the encoded job. Chromium applies the same rules in headless mode, so the output matches the preview.</p>
          <p>If your document needs additional assets (fonts, images, stylesheets), place them next to the original HTML file and ensure paths are relative. Provide a matching base URL above so the viewer can resolve those references when previewing or printing headlessly.</p>
        </div>
      </details>
    </section>

    <section class="preview" aria-label="Preview">
      <div id="preview-placeholder" class="preview-placeholder">
        <p><strong>Drop an HTML file</strong> to start previewing. Use the controls on the left to match your target PDF layout, then print straight from the browser or run the export command headlessly.</p>
        <p class="note">Large documents may take a moment to appear while resources are loaded.</p>
      </div>
      <iframe id="preview" title="Document preview" hidden></iframe>
    </section>
  </main>

  <script>
    (function () {
      const fileInput = document.getElementById('file-input');
      const preview = document.getElementById('preview');
      const placeholder = document.getElementById('preview-placeholder');
      const statusEl = document.getElementById('status');
      const applyBtn = document.getElementById('apply');
      const printBtn = document.getElementById('print');
      const copyBtn = document.getElementById('copy-command');
      const commandOutput = document.getElementById('command-output');
      const scaleInput = document.getElementById('scale');
      const scaleDisplay = document.getElementById('scale-display');
      const baseInput = document.getElementById('base-url');
      const pageSize = document.getElementById('page-size');
      const customSizeFields = document.getElementById('custom-size-fields');
      const customWidth = document.getElementById('custom-width');
      const customHeight = document.getElementById('custom-height');
      const customUnit = document.getElementById('custom-unit');
      const orientation = document.getElementById('orientation');
      const marginPreset = document.getElementById('margin-preset');
      const customMargins = document.getElementById('custom-margins');
      const marginTop = document.getElementById('margin-top');
      const marginRight = document.getElementById('margin-right');
      const marginBottom = document.getElementById('margin-bottom');
      const marginLeft = document.getElementById('margin-left');
      const printBackgrounds = document.getElementById('print-backgrounds');
      const emulateScreen = document.getElementById('emulate-screen');
      const virtualTime = document.getElementById('virtual-time');
      const autoPrint = document.getElementById('auto-print');
      const form = document.getElementById('options-form');

      const deepClone = (value) => {
        if (typeof structuredClone === 'function') {
          return structuredClone(value);
        }
        return JSON.parse(JSON.stringify(value));
      };

      const defaultOptions = {
        pageSize: 'A4',
        customSize: { width: 210, height: 297, unit: 'mm' },
        orientation: 'portrait',
        marginPreset: 'normal',
        customMargins: { top: 1, right: 1, bottom: 1, left: 1 },
        scale: 1,
        printBackgrounds: false,
        emulateScreen: true,
        virtualTime: 1000,
        autoPrint: false
      };

      const state = {
        fileName: '',
        fileContent: '',
        options: deepClone(defaultOptions),
        lastCommandHash: '',
        baseUrl: ''
      };

      function updateScaleDisplay() {
        scaleDisplay.textContent = Math.round(scaleInput.value) + '%';
      }

      function showStatus(message, { tone = 'info' } = {}) {
        statusEl.textContent = message;
        statusEl.dataset.tone = tone;
      }

      function setPreviewVisible(visible) {
        preview.hidden = !visible;
        placeholder.hidden = visible;
      }

      function readFile(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = () => reject(reader.error || new Error('Failed to read file'));
          reader.readAsText(file);
        });
      }

      function encodeToBase64(str) {
        const encoder = new TextEncoder();
        const bytes = encoder.encode(str);
        let binary = '';
        const chunk = 0x8000;
        for (let i = 0; i < bytes.length; i += chunk) {
          const slice = bytes.subarray(i, i + chunk);
          binary += String.fromCharCode.apply(null, slice);
        }
        return btoa(binary);
      }

      function decodeBase64(str) {
        const binary = atob(str);
        const bytes = new Uint8Array(binary.length);
        for (let i = 0; i < binary.length; i++) {
          bytes[i] = binary.charCodeAt(i);
        }
        return new TextDecoder().decode(bytes);
      }

      function buildPageSize(options) {
        if (options.pageSize !== 'Custom') {
          return options.pageSize + ' ' + options.orientation;
        }
        const width = options.customSize.width + options.customSize.unit;
        const height = options.customSize.height + options.customSize.unit;
        return `${width} ${height}`;
      }

      function buildMarginString(options) {
        switch (options.marginPreset) {
          case 'normal':
            return '1in';
          case 'narrow':
            return '0.5in';
          case 'wide':
            return '1.5in';
          case 'none':
            return '0';
          case 'custom':
          default:
            const { top, right, bottom, left } = options.customMargins;
            return `${top}in ${right}in ${bottom}in ${left}in`;
        }
      }

      function generatePrintCss(options) {
        const parts = [];
        parts.push(`@page { size: ${buildPageSize(options)}; margin: ${buildMarginString(options)}; }`);
        const bodyBits = ['html, body { height: auto !important; }'];
        if (options.emulateScreen) {
          bodyBits.push('html { background: inherit !important; }');
          bodyBits.push('body { background: inherit !important; }');
        }
        if (options.printBackgrounds) {
          bodyBits.push('html { print-color-adjust: exact; -webkit-print-color-adjust: exact; }');
          bodyBits.push('body { print-color-adjust: exact; -webkit-print-color-adjust: exact; }');
        }
        bodyBits.push(`body { zoom: ${options.scale}; }`);
        parts.push(bodyBits.join('\n'));
        return parts.join('\n');
      }

      function ensurePrintStyle(doc) {
        let style = doc.getElementById('print-directives');
        if (!style) {
          style = doc.createElement('style');
          style.id = 'print-directives';
          doc.head.appendChild(style);
        }
        return style;
      }

      function rewriteAssetUrls(doc, base) {
        if (!base) return;
        const attrs = ['href', 'src'];
        attrs.forEach((attr) => {
          doc.querySelectorAll(`[${attr}]`).forEach((el) => {
            const value = el.getAttribute(attr);
            if (!value || value.startsWith('data:') || value.startsWith('http') || value.startsWith('blob:') || value.startsWith('chrome:')) {
              return;
            }
            try {
              const resolved = new URL(value, base).href;
              el.setAttribute(attr, resolved);
            } catch (err) {
              console.warn('Failed to resolve asset URL', value, err);
            }
          });
        });
      }

      function applyPrintStyles() {
        const doc = preview.contentDocument;
        if (!doc) return;
        const style = ensurePrintStyle(doc);
        style.textContent = generatePrintCss(state.options);
      }

      function setPreviewContent(html, baseUrl) {
        setPreviewVisible(true);
        preview.addEventListener('load', () => {
          const doc = preview.contentDocument;
          if (!doc) return;
          rewriteAssetUrls(doc, baseUrl || state.baseUrl || undefined);
          applyPrintStyles();
          showStatus(`Loaded “${state.fileName || 'document'}” (${html.length.toLocaleString()} characters).`);
        }, { once: true });
        preview.srcdoc = html;
      }

      function collectOptionsFromForm() {
        const opts = deepClone(state.options);
        opts.pageSize = pageSize.value;
        opts.orientation = orientation.value;
        opts.marginPreset = marginPreset.value;
        opts.scale = Number(scaleInput.value) / 100;
        opts.printBackgrounds = printBackgrounds.checked;
        opts.emulateScreen = emulateScreen.checked;
        opts.virtualTime = Number(virtualTime.value) || 0;
        opts.autoPrint = autoPrint.checked;
        if (opts.pageSize === 'Custom') {
          opts.customSize = {
            width: Number(customWidth.value) || 1,
            height: Number(customHeight.value) || 1,
            unit: customUnit.value
          };
        }
        if (opts.marginPreset === 'custom') {
          opts.customMargins = {
            top: Number(marginTop.value) || 0,
            right: Number(marginRight.value) || 0,
            bottom: Number(marginBottom.value) || 0,
            left: Number(marginLeft.value) || 0
          };
        }
        return opts;
      }

      function syncFormWithOptions(options) {
        pageSize.value = options.pageSize;
        orientation.value = options.orientation;
        marginPreset.value = options.marginPreset;
        scaleInput.value = Math.round(options.scale * 100);
        printBackgrounds.checked = options.printBackgrounds;
        emulateScreen.checked = options.emulateScreen;
        virtualTime.value = options.virtualTime;
        autoPrint.checked = options.autoPrint;
        if (options.pageSize === 'Custom') {
          customWidth.value = options.customSize.width;
          customHeight.value = options.customSize.height;
          customUnit.value = options.customSize.unit;
        }
        if (options.marginPreset === 'custom') {
          marginTop.value = options.customMargins.top;
          marginRight.value = options.customMargins.right;
          marginBottom.value = options.customMargins.bottom;
          marginLeft.value = options.customMargins.left;
        }
        updateScaleDisplay();
        updateConditionalFields();
      }

      function updateConditionalFields() {
        customSizeFields.hidden = pageSize.value !== 'Custom';
        customMargins.hidden = marginPreset.value !== 'custom';
      }

      function buildJobHash() {
        if (!state.fileContent) {
          commandOutput.value = 'Load a document to produce a command.';
          state.lastCommandHash = '';
          return '';
        }
        const job = {
          version: 1,
          name: state.fileName,
          options: state.options,
          content: encodeToBase64(state.fileContent),
          autoPrint: state.options.autoPrint,
          baseUrl: state.baseUrl || undefined
        };
        const json = JSON.stringify(job);
        const encoded = encodeURIComponent(btoa(json));
        state.lastCommandHash = encoded;
        return encoded;
      }

      function updateCommandOutput() {
        const hash = buildJobHash();
        if (!hash) {
          return;
        }
        const commandParts = [
          'chrome --headless=new',
          '--disable-gpu',
          '--run-all-compositor-stages-before-draw',
          `--virtual-time-budget=${state.options.virtualTime}`,
          '--allow-file-access-from-files',
          `--print-to-pdf="output.pdf"`,
          '--print-to-pdf-no-header'
        ];
        if (state.options.printBackgrounds) {
          commandParts.push('--print-to-pdf-backgrounds');
        }
        if (state.options.scale && state.options.scale !== 1) {
          commandParts.push(`--print-to-pdf-scale=${state.options.scale.toFixed(2)}`);
        }
        const viewerPathPlaceholder = '<path-to-viewer>/viewer.html';
        const url = `file://${viewerPathPlaceholder}#${hash}`;
        commandParts.push(`"${url}"`);
        commandOutput.value = commandParts.join(' ');
        history.replaceState(null, '', '#' + hash);
      }

      function applyOptions() {
        state.options = collectOptionsFromForm();
        applyPrintStyles();
        updateCommandOutput();
        showStatus('Layout updated. Ready to print.');
      }

      async function handleFileInput(event) {
        const file = event.target.files?.[0];
        if (!file) {
          return;
        }
        try {
          showStatus('Reading file…');
          const content = await readFile(file);
          state.fileName = file.name;
          state.fileContent = content;
          state.baseUrl = baseInput.value.trim();
          setPreviewContent(content, state.baseUrl || undefined);
          state.options = collectOptionsFromForm();
          updateCommandOutput();
        } catch (error) {
          console.error(error);
          showStatus('Could not load the file. See console for details.', { tone: 'error' });
        }
      }

      function handlePrint() {
        if (!preview.contentWindow) {
          showStatus('Load a document first.', { tone: 'error' });
          return;
        }
        preview.contentWindow.focus();
        preview.contentWindow.print();
      }

      async function copyCommandToClipboard() {
        if (!state.lastCommandHash) {
          updateCommandOutput();
          if (!state.lastCommandHash) {
            showStatus('Nothing to copy yet — load a document first.', { tone: 'error' });
            return;
          }
        }
        try {
          await navigator.clipboard.writeText(commandOutput.value);
          showStatus('Headless print command copied to clipboard.');
        } catch (error) {
          console.warn(error);
          commandOutput.select();
          document.execCommand('copy');
          showStatus('Command copied (fallback). If that failed, copy manually.');
        }
      }

      function loadJobFromHash() {
        if (!location.hash || location.hash.length <= 1) {
          return;
        }
        try {
          const decoded = atob(decodeURIComponent(location.hash.slice(1)));
          const job = JSON.parse(decoded);
          if (!job || !job.content) {
            return;
          }
          state.fileName = job.name || 'document.html';
          state.fileContent = decodeBase64(job.content);
          state.options = Object.assign(deepClone(defaultOptions), job.options || {});
          state.options.autoPrint = Boolean(job.autoPrint);
          state.baseUrl = job.baseUrl || '';
          baseInput.value = state.baseUrl;
          syncFormWithOptions(state.options);
          setPreviewContent(state.fileContent, state.baseUrl || undefined);
          updateCommandOutput();
          if (state.options.autoPrint) {
            setTimeout(() => {
              if (preview.contentWindow) {
                preview.contentWindow.print();
              }
            }, 600);
          }
        } catch (error) {
          console.error('Failed to load job from hash', error);
          showStatus('Invalid job data in URL fragment.', { tone: 'error' });
        }
      }

      fileInput.addEventListener('change', handleFileInput);
      pageSize.addEventListener('change', () => {
        updateConditionalFields();
        applyOptions();
      });
      customWidth.addEventListener('input', applyOptions);
      customHeight.addEventListener('input', applyOptions);
      customUnit.addEventListener('change', applyOptions);
      orientation.addEventListener('change', applyOptions);
      marginPreset.addEventListener('change', () => {
        updateConditionalFields();
        applyOptions();
      });
      [marginTop, marginRight, marginBottom, marginLeft].forEach((input) => input.addEventListener('input', applyOptions));
      scaleInput.addEventListener('input', () => {
        updateScaleDisplay();
        applyOptions();
      });
      printBackgrounds.addEventListener('change', applyOptions);
      emulateScreen.addEventListener('change', applyOptions);
      virtualTime.addEventListener('input', applyOptions);
      autoPrint.addEventListener('change', applyOptions);
      applyBtn.addEventListener('click', applyOptions);
      printBtn.addEventListener('click', handlePrint);
      copyBtn.addEventListener('click', copyCommandToClipboard);
      window.addEventListener('hashchange', loadJobFromHash);
      baseInput.addEventListener('input', () => {
        state.baseUrl = baseInput.value.trim();
        const doc = preview.contentDocument;
        if (doc) {
          rewriteAssetUrls(doc, state.baseUrl || undefined);
        }
        updateCommandOutput();
      });

      updateScaleDisplay();
      updateConditionalFields();
      loadJobFromHash();
    })();
  </script>
</body>
</html>
